server:
  port: 8082

spring:

  application:
    name: job-executor-service

  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.jobrunr.JobRunrAutoConfiguration

  datasource:
    url: jdbc:postgresql://localhost:5432/job_demo_database
    username: postgres
    password: postgres


  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true


  kafka:
    bootstrap-servers: localhost:9092

    consumer:
      group-id: ${spring.application.name}-job-consumer
      enable-auto-commit: false
      auto-offset-reset: earliest
      fetch-min-size: 1024
      fetch-max-wait: 500
      properties:
        session.timeout.ms: 45000
        session-timeout-ms: 180000      # 3 minutos
        max.poll.interval.ms: 28800000  # 8 horas para jobs largos
        max.poll.records: 10
        heartbeat.interval.ms: 3000
        isolation.level: read_committed
        spring.json.trusted.packages: "*"
        spring.json.value.default.type: common.batch.dto.JobRequest
        spring.json.use.type.headers: false
    listener:
      ack-mode: manual_immediate
      concurrency: 3
      poll-timeout: 5000
      missing-topics-fatal: false

# Configuración de filtrado
kafka:
  topics:
    job-requests: job-requests-topic
    job-results: job-results-topic
    dead-letter-queue: job-requests-dlq
    retry-topic: job-requests-retry
    retry-suffix: "-retry"
    dlq-suffix: "-dlq"

  filter:
    enabled: true
    business-domains: "job-executor-service"  # Solo procesar este business-domain
    target-batches: "ResumenDiarioClientesAsync"     # Solo procesar este target-batch

  consumer:
    concurrency: 3
    poll-timeout: 5000
    retry:
      max-attempts: 3
      backoff-delay: 1000
      max-delay: 10000
    dlq:
      enabled: true
      max-retries: 3

# Configuración del job
job:
  max-retries: 3
  retry-delay-ms: 5000

org:
  jobrunr:
    enabled: false

jobrunr:
  background-job-server:
    enabled: false

# Actuator y métricas
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
    enabled-by-default: true

  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    metrics:
      enabled: true
    prometheus:
      enabled: true

  metrics:
    export:
      prometheus:
        enabled: true
        step: 30s  # Frecuencia de exportación
    enable:
      kafka: true
      jvm: true
      system: true
      logback: true
      processor: true

    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active:local}
      region: local

    distribution:
      percentiles-histogram:
        http.server.requests: true
        kafka.consumer.fetch.manager.records.consumed: true
      sla:
        http.server.requests: 10ms, 50ms, 100ms, 200ms, 500ms, 1s, 5s


# Logging específico para Kafka
logging:
  level:
    org.springframework.kafka: INFO
    org.apache.kafka: WARN
    com.company.jobexecutor.kafka: DEBUG
